<!DOCTYPE html>
<html lang="uz">

<head>
    <meta charset="utf-8" />
    <title>Dashboard — PS Club</title>
    <link rel="icon" href="./logo.png" />
    <link rel="stylesheet" href="/shared.css" />
</head>

<body>
    <div class="container">
        <h2 style="font-size: 40px;">Dashboard</h2>
        <div class="dashboard-form">
            <div>
                <h3>Zakaz qo'shish</h3>
                <div class="small">PS</div>
                <select id="psSelect">
                    <option>PS1</option>
                    <option>PS2</option>
                    <option>PS3</option>
                    <option>PS4</option>
                    <option>PS5</option>
                </select>
                <div class="small">Turi</div>
                <select id="typeSelect">
                    <option value="cash">Naqd</option>
                    <option value="vip">VIP</option>
                </select>
                <div class="small">Summa (naqd uchun)</div>
                <input id="amount" type="number" placeholder="15,000" style="padding: 15px;" />
                <div style="margin-top:8px">
                    <button id="addBtn" class="btn btn-primary"
                        style="    font-size: 35px; border: 1px solid #9b5cff;">Qo'shish</button>
                </div>
            </div>
            <div>
                <h3>Stats</h3>
                <div id="stats" class="small">Yuklanmoqda...</div>
            </div>
        </div>

        <div class="card">
            <h3 style="font-size: 2em;">Oxirgi zakazlar</h3>
            <ul id="recentList" class="list"></ul>
        </div>

        <div id="loading" style="display:none;text-align:center;margin:20px;">
            <!-- Spinner icon SVG -->
            <svg width="48" height="48" viewBox="0 0 48 48" fill="none">
                <circle cx="24" cy="24" r="20" stroke="#8d51c7" stroke-width="6" opacity="0.2" />
                <path d="M44 24a20 20 0 1 1-20-20" stroke="#8d51c7" stroke-width="6" stroke-linecap="round" />
            </svg>
            <div>Yuklanmoqda...</div>
        </div>
    </div>

    <script src="/app.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            if (!requireAuth()) return;
            buildNav();

            // VIP tanlansa, summa input bloklanadi
            const typeSelect = document.getElementById("typeSelect");
            const amountInput = document.getElementById("amount");
            typeSelect.onchange = () => {
                if (typeSelect.value === "vip") {
                    amountInput.value = "";
                    amountInput.readOnly = true;
                    amountInput.style.background = "#eee";
                } else {
                    amountInput.readOnly = false;
                    amountInput.style.background = "";
                }
            };

            async function loadStats() {
                try {
                    const orders = await fetch("/api/orders", { headers: authHeaders() }).then(r => r.json());
                    // Faqat trash bo'lmaganlarni olamiz:
                    const filtered = orders.filter(o => o.status !== "trash");
                    const total = filtered.reduce((s, o) => s + Number(o.summa || 0), 0);
                    const processCount = filtered.filter(o => o.status === "process").length;
                    const completedCount = filtered.filter(o => o.status === "completed").length;
                    document.getElementById("stats").innerText = `Jami zakaz: ${filtered.length}
                     Faol : ${processCount}
                     Yakunlangan : ${completedCount} 
                     Jami summa: ${total.toLocaleString()} so'm`;
                    const recent = filtered.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)).slice(0, 6);
                    const el = document.getElementById("recentList"); el.innerHTML = "";
                    recent.forEach(o => {
                        const statusUz = o.status === "process" ? "Faol" : o.status === "completed" ? "Yakunlangan" : "Trash";
                        const li = document.createElement("li");
                        li.innerHTML = `${o.ps} | ${o.type} | ${Number(o.summa).toLocaleString()} so'm | ${new Date(o.createdAt).toLocaleString()} | <span style="color: ${o.status === "completed" ? "#43d97a" : "#ff5c5c"};">${statusUz}</span>`;
                        el.appendChild(li);
                    });
                } catch (e) {
                    console.error(e);
                }
            }

            document.getElementById("addBtn").addEventListener("click", async () => {
                const ps = document.getElementById("psSelect").value;
                const type = document.getElementById("typeSelect").value;
                const amount = Number(document.getElementById("amount").value || 0);
                if (type === "cash" && (!amount || amount <= 0)) {
                    await modalAlert("Naqd zakaz uchun summa majburiy!", "Xato");
                    return;
                }
                // Yangi: tasdiqlash
                const confirm = await modalConfirm(
                    `Zakaz qo‘shilsinmi?<br><b>PS:</b> ${ps}<br><b>Turi:</b> ${type.toUpperCase()}<br><b>Summa:</b> ${amount.toLocaleString()} so'm`,
                    "Zakaz qo‘shish"
                );
                if (!confirm) return;
                try {
                    const res = await fetch("/api/order", { method: "POST", headers: authHeaders(), body: JSON.stringify({ ps, type, amount }) });
                    const j = await res.json();
                    if (j.ok) { await modalAlert("Zakaz qo‘shildi!"); document.getElementById("amount").value = ""; loadStats(); }
                    else await modalAlert("Xato: " + (j.error || JSON.stringify(j)), "Xato");
                } catch (e) { console.error(e); await modalAlert("Xato", "Xato"); }
            });

            loadStats();
            setInterval(loadStats, 5000);
        });
    </script>
</body>

</html>