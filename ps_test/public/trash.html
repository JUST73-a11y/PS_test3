<!DOCTYPE html>
<html lang="uz">

<head>
    <meta charset="utf-8" />
    <title>Trash — PS Club</title>
    <link rel="stylesheet" href="/shared.css" />
</head>

<body>
    <script src="/app.js"></script>
    <div class="container">
        <script> requireAuth(); buildNav(); </script>
        <h2>Trash (faqat Super Admin)</h2>
        <div class="card">
            <button id="loadTrash" class="btn">Load Trash</button>
            <ul id="trashList" class="list"></ul>
        </div>
    </div>

    <script>
        document.getElementById("loadTrash").onclick = async () => {
            const superKey = await modalPrompt("Super admin keyni kiriting:", "Super admin");
            if (!superKey) return modalAlert("Key kerak");
            const res = await fetch("/api/trash", { headers: authHeaders({ "super-key": superKey }) });
            const j = await res.json();
            if (j.error) return modalAlert("Xato: " + j.error);
            const el = document.getElementById("trashList"); el.innerHTML = "";
            j.forEach(o => {
                const li = document.createElement("li");
                li.innerHTML = `
                    ID:${o.orderId ?? o.externalId} | ${o.ps} | ${o.type} | ${o.summa} so'm | deletedAt: ${o.deletedAt}
                    <button class="btn success" onclick="restoreOrder('${o._id}')">♻️ Restore</button>
                    <button class="btn danger" onclick="deleteOrderPermanently('${o._id}')">❌ Delete</button>
                `;
                el.appendChild(li);
            });
        };

        // Restore order (status: trash -> process)
        window.restoreOrder = async (id) => {
            // superKey so‘ralmasin!
            const res = await fetch("/api/restore/" + id, {
                method: "POST",
                headers: authHeaders()
            });
            const j = await res.json();
            if (j.ok) {
                await modalAlert("Zakaz qayta tiklandi!");
                document.getElementById("loadTrash").click();
            } else {
                await modalAlert("Xato: " + (j.error || JSON.stringify(j)));
            }
        };

        // Delete order permanently
        window.deleteOrderPermanently = async (id) => {
            if (!(await modalConfirm("Haqiqiy o‘chirishni xohlaysizmi? Bu qaytarib bo‘lmaydi!"))) return;
            if (!window._superKey) {
                window._superKey = await modalPrompt("Super admin keyni kiriting:", "Super admin");
                if (!window._superKey) return modalAlert("Key kerak");
            }
            const res = await fetch("/api/order/" + id + "?permanent=1", {
                method: "DELETE",
                headers: authHeaders({ "super-key": window._superKey })
            });
            const j = await res.json();
            if (j.ok) {
                await modalAlert("Zakaz butunlay o‘chirildi!");
                document.getElementById("loadTrash").click();
            } else {
                await modalAlert("Xato: " + (j.error || JSON.stringify(j)));
                window._superKey = null; // noto‘g‘ri bo‘lsa, keyni yana so‘rash uchun
            }
        };
    </script>
</body>

</html>